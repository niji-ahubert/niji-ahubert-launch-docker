version: '3'
dotenv: ['.env']
vars:
  WSL_PATH_FOLDER_SOCLE_ROOT:
    sh: 'pwd'
  DOCKER_GID:
    sh: 'getent group docker | cut -d: -f3'
  DOCKER_COMP: docker --log-level=ERROR compose --project-name generator-socle
  DOCKER_EXEC: '{{.DOCKER_COMP}} exec'
  DOCKER_ADMIN_COMP: docker --log-level=ERROR compose -f docker-compose.admin.yml
  ENV_IP_WSL_ETH:
    sh: printenv IP_WSL_ETH
tasks:

  build-webserver-sf:
    desc: "ğŸ”¨ Build webserver PHP container for admin"
    silent: true
    cmds:
      - echo "ğŸ”¨ Building webserver PHP container..."
      - 'docker --log-level=ERROR compose -f docker-compose.admin.yml build webserver-php'

  assets-compile:
    desc: "ğŸ”§ Compile Symfony assets"
    cmds:
      - '{{.DOCKER_ADMIN_COMP}} exec webserver-php bin/console asset-map:compile'

  composer-audit:
    desc: "ğŸ” Run composer audit"
    silent: true
    cmds:
     - echo "ğŸ”’ Running Security Check..."
     - 'docker run --rm --interactive --tty --user $(id -u):$(id -g) --env GIT_SAFE_DIRECTORY=* --volume $PWD:/app composer audit'


  composer-oudated:
    desc: "ğŸ” Check for outdated packages"
    silent: true
    cmds:
      - echo "ğŸ”’ Checking for outdated packages..."
      - 'docker run --rm --interactive --tty --user $(id -u):$(id -g) --env GIT_SAFE_DIRECTORY=* --volume $PWD:/app composer outdated'

  security:
    desc: "ğŸ”’ Run Trivy security scan"
    silent: true
    cmds:
      - echo "ğŸ”’ Running Trivy security scan..."
      - 'docker run --rm -v $(pwd):/app -v ${HOME}/.trivy/.cache:/root/.cache/ -w /app aquasec/trivy:latest --exit-code 1 fs --scanners vuln .'
    
  phpstan:
    desc: "ğŸ” Run phpstan"
    silent: true
    cmds:
      - echo "ğŸ” Running PHPStan..."
      - '{{.DOCKER_ADMIN_COMP}} exec -e XDEBUG_MODE=off webserver-php vendor/bin/phpstan analyse src --memory-limit=-1'

  rector:
    desc: "ğŸ” Run rector"
    silent: true
    cmds:
      - echo "ğŸ” Running Rector..."
      - '{{.DOCKER_ADMIN_COMP}} exec -e XDEBUG_MODE=off webserver-php vendor/bin/rector process --config rector.php'

  phpcsfixer:
    desc: "ğŸ” Run php-cs-fixer"
    silent: true
    cmds:
      - echo "ğŸ” Running PHP-CS-Fixer..."
      - '{{.DOCKER_ADMIN_COMP}} exec -e XDEBUG_MODE=off webserver-php vendor/bin/php-cs-fixer fix --config .php-cs-fixer.dist.php --diff'

  qa:
    desc: "ğŸ” Run quality assurance tools"
    cmds:
      - task: rector
      - task: phpcsfixer
      - task: phpstan
      - task: security
      - task: composer-audit
      - task: composer-oudated



  bash:
    desc: "ğŸš Start a bash shell in webserver for new project"
    silent: true
    cmds:
      - '{{.DOCKER_ADMIN_COMP}} --profile webserver --profile webserver exec webserver-php bash'


  default:
    desc: "Show help message"
    silent: true
    cmds:
      - task --list

  requirement:
    desc: "ğŸ” Check and validate requirements"
    internal: true
    silent: true
    cmds:
      - |
        echo "ğŸ” VÃ©rification des prÃ©requis systÃ¨me"
        echo "âœ… Tous les prÃ©requis sont satisfaits"

  start:
    desc: "ğŸš€ Start webserver for new project development"
    silent: true
    deps:
      - requirement
      - traefik_up
      - stop
    cmds:
      - echo "ğŸš€ Start webserver for new project development"
      - 'IP_WSL_ETH={{.ENV_IP_WSL_ETH}} DOCKER_GID={{.DOCKER_GID}} WSL_PATH_FOLDER_SOCLE_ROOT={{.WSL_PATH_FOLDER_SOCLE_ROOT}} WSL_PATH_FOLDER_PROJECTS_ROOT={{.WSL_PATH_FOLDER_PROJECTS_ROOT}} HOST_UID=$(id -u) HOST_GID=$(id -g) {{.DOCKER_ADMIN_COMP}} --profile webserver up --detach'
      - echo "ğŸŒ Votre application est disponible sur https://niji-generator.docker.localhost"

  stop:
    desc: "â¹ï¸ Stop the docker-compose stack for new project"
    silent: true
    cmds:
      - echo "â¹ï¸ Stop the docker-compose stack for new project"
      - '{{.DOCKER_ADMIN_COMP}} --profile webserver down --remove-orphans'

  traefik_up:
    desc: "ğŸŒ Start and check Traefik health"
    internal: true
    silent: true
    cmds:
      - ./bin/healthcheckTraefik.sh
