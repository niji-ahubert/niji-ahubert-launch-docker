version: '3'
dotenv: ['.env']
vars:
  PROJECT_ROOT:
    sh: 'pwd'
  DOCKER_GID:
    sh: 'getent group docker | cut -d: -f3'
  DOCKER_COMP: docker --log-level=ERROR compose --project-name generator-socle
  DOCKER_EXEC: '{{.DOCKER_COMP}} exec'
  DOCKER_ADMIN_COMP: docker --log-level=ERROR compose -f docker-compose.admin.yml
  ENV_IP_WSL_ETH:
    sh: printenv IP_WSL_ETH
tasks:
  assets-compile:
    desc: "üîß Compile Symfony assets"
    cmds:
      - '{{.DOCKER_ADMIN_COMP}} exec webserver-php bin/console asset-map:compile'

  composer-audit:
    desc: "üîç Run composer audit"
    silent: true
    cmds:
     - echo "Running Security Check..."
     - 'docker run --rm --interactive --tty --env GIT_SAFE_DIRECTORY=* --volume $PWD:/app composer audit'

  composer-oudated:
    desc: "üîç Check for outdated packages"
    silent: true
    cmds:
      - echo "Checking for outdated packages..."
      - 'docker run --rm --interactive --tty --env GIT_SAFE_DIRECTORY=* --volume $PWD:/app composer outdated'

  phpstan:
    desc: "üîç Run phpstan"
    silent: true
    cmds:
      - echo "Running PHPStan..."
      - 'docker run --rm -v $(pwd):/app ghcr.io/phpstan/phpstan analyse --memory-limit=-1'

  qa:
    desc: "üîç Run quality assurance tools"
    cmds:
      - echo "Running Rector..."
      - '{{.DOCKER_ADMIN_COMP}} exec -e XDEBUG_MODE=off webserver-php vendor/bin/rector process --config rector.php'
      - echo "Running PHP-CS-Fixer..."
      - '{{.DOCKER_ADMIN_COMP}} exec -e XDEBUG_MODE=off webserver-php vendor/bin/php-cs-fixer fix --config .php-cs-fixer.dist.php --diff'
      - echo "Running PHPStan..."
      - '{{.DOCKER_ADMIN_COMP}} exec -e XDEBUG_MODE=off webserver-php vendor/bin/phpstan analyse src --memory-limit=-1'


  bash:
    desc: "üêö Start a bash shell in webserver for new project"
    silent: true
    cmds:
      - '{{.DOCKER_ADMIN_COMP}} --profile webserver --profile webserver exec webserver-php bash'


  default:
    desc: "Show help message"
    silent: true
    cmds:
      - task --list

  requirement:
    desc: "üîç Check and validate requirements"
    internal: true
    silent: true
    cmds:
      - |
        echo "üîç V√©rification des pr√©requis syst√®me"
        echo "‚úÖ Tous les pr√©requis sont satisfaits"

  start:
    desc: "üöÄ Start webserver for new project development"
    silent: true
    deps:
      - requirement
      - traefik_up
      - stop
    cmds:
      - echo "üöÄ Start webserver for new project development"
      - 'IP_WSL_ETH={{.ENV_IP_WSL_ETH}} DOCKER_GID={{.DOCKER_GID}} PROJECT_ROOT={{.PROJECT_ROOT}} PROJECTS_ROOT_HOST={{.PROJECTS_ROOT_HOST}} HOST_UID=$(id -u) HOST_GID=$(id -g) {{.DOCKER_ADMIN_COMP}} --profile webserver up --detach'
      - echo "üåê Votre application est disponible sur https://niji-generator.docker.localhost"

  stop:
    desc: "‚èπÔ∏è Stop the docker-compose stack for new project"
    silent: true
    cmds:
      - echo "‚èπÔ∏è Stop the docker-compose stack for new project"
      - '{{.DOCKER_ADMIN_COMP}} --profile webserver down --remove-orphans'

  traefik_up:
    desc: "üåê Start and check Traefik health"
    internal: true
    silent: true
    cmds:
      - ./bin/healthcheckTraefik.sh
